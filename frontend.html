<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hrlucas.dev · LPR Webhook</title>
    <link rel="icon" type="image/svg+xml" href="/assets/logo_hr_azul.svg" sizes="any">
    <link rel="mask-icon" href="/assets/logo_hr_azul.svg" color="#175098">
    <meta name="theme-color" content="#00305b">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* PALETA HRLUCAS.DEV */
        :root {
            --azul-escuro: #00305b;
            --azul-escurecido: #0a5080;
            --azul: #175098;
            --azul-vivo: #0086cd;
            --azul-acento: #0086cd;
            --preto: #000000;
            --branco: #ffffff;
            --fundo: #f8f9fa;
            --borda: #dee2e6;
            --cinza: #6c757d;

            --azul-medio: var(--azul);
            --cinza-claro: var(--fundo);
            --cinza-medio: #e9ecef;
            --cinza-borda: var(--borda);
            --cinza-texto: var(--cinza);

            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", sans-serif;
        }

        [data-theme="dark"] {
            --azul-escuro: #e5edf7;
            --azul-escurecido: #0f3b5f;
            --azul: #1f5fa2;
            --azul-vivo: #19a0e6;
            --azul-acento: #19a0e6;
            --preto: #000000;
            --branco: #111827;
            --fundo: #0b1220;
            --borda: #1f2a44;
            --cinza: #9aa4b2;

            --azul-medio: var(--azul);
            --cinza-claro: var(--fundo);
            --cinza-medio: #111827;
            --cinza-borda: var(--borda);
            --cinza-texto: var(--cinza);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100vh;
            overflow: hidden;
            background-color: var(--fundo);
            color: var(--azul-escuro);
            font-family: var(--font-main);
        }

        /* LAYOUT PRINCIPAL */
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }


        .content-grid {
            display: grid;
            grid-template-columns: 22% 78%;
            gap: 1.5rem;
            padding: 1.5rem;
            height: 100vh;
            overflow: hidden;
        }


        .left-column {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            overflow: hidden;
        }


        .logo-container {
            background-color: var(--branco);
            border: 1px solid var(--cinza-borda);
            border-radius: 8px;
            padding: 1.2rem 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            flex-shrink: 0;
            min-height: 160px;
        }

        .logo-container img {
            max-width: 90%;
            max-height: 140px;
            object-fit: contain;
        }

        .logo-title {
            margin-top: 0.2rem;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 1.2px;
            text-transform: uppercase;
            color: var(--azul-escuro);
            text-align: center;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .logo-title img {
            width: 16px;
            height: 16px;
        }

        .theme-toggle {
            border: 1px solid var(--cinza-borda);
            background: var(--branco);
            color: var(--azul-escuro);
            border-radius: 50%;
            width: 46px;
            height: 46px;
            padding: 0;
            font-weight: 700;
            font-size: 20px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: border-color 0.2s ease, color 0.2s ease, background 0.2s ease, transform 0.15s ease;
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 3000;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.10);
        }

        .theme-toggle:hover {
            border-color: var(--azul-acento);
            transform: translateY(-1px);
        }


        .metric-card {
            background-color: var(--branco);
            border-radius: 8px;
            padding: 1rem 1.1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            border: 1px solid var(--cinza-borda);
            transition: box-shadow 0.2s;
            flex-shrink: 0;
        }

        .metric-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .metric-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--cinza-texto);
            margin-bottom: 0.6rem;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 48px;
            font-weight: 700;
            color: var(--azul-escuro);
            margin: 0;
            line-height: 1;
        }


        .metric-datetime {
            font-size: 13px;
            color: var(--cinza-texto);
            margin-top: 0.35rem;
            margin-bottom: 0;
            font-weight: 400;
            line-height: 1.1;
        }

        .metric-plate {
            font-size: 48px;
            font-weight: 700;
            color: var(--azul-escuro);
            margin: 0.2rem 0;
            line-height: 1;
            letter-spacing: 2px;
        }

        .metric-time {
            font-size: 13px;
            color: var(--cinza-texto);
            margin: 0;
            font-weight: 400;
        }

        /* FILTROS COMPACTOS */
        .filters-card {
            background-color: var(--branco);
            border-radius: 8px;
            padding: 1rem 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            border: 1px solid var(--cinza-borda);
            flex-shrink: 1;
            min-height: 0;
        }

        .filters-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--cinza-texto);
            margin-bottom: 0.8rem;
            letter-spacing: 0.5px;
        }

        .filter-group {
            margin-bottom: 0.8rem;
        }

        .filter-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--azul-escuro);
            margin-bottom: 0.3rem;
            display: block;
            letter-spacing: 0.3px;
        }

        .filter-input {
            width: 100%;
            padding: 0.5rem 0.7rem;
            border: 1px solid var(--cinza-borda);
            border-radius: 4px;
            font-size: 13px;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: var(--branco);
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--azul-escuro);
            box-shadow: 0 0 0 3px rgba(19, 25, 51, 0.1);
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.8rem;
        }

        .btn-filter {
            flex: 1;
            padding: 0.6rem;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.3px;
        }

        .btn-primary-custom {
            background-color: var(--azul-escuro);
            color: var(--branco);
        }

        .btn-primary-custom:hover {
            background-color: var(--azul-escurecido);
        }

        .btn-secondary-custom {
            background-color: var(--cinza-medio);
            color: var(--azul-escuro);
            border: 1px solid var(--cinza-borda);
        }

        .btn-secondary-custom:hover {
            background-color: var(--cinza-borda);
        }

        [data-theme="dark"] .btn-primary-custom {
            background-color: var(--azul);
            color: #ffffff;
            border: 1px solid #2a67a4;
        }

        [data-theme="dark"] .btn-primary-custom:hover {
            background-color: var(--azul-vivo);
        }

        [data-theme="dark"] .btn-secondary-custom {
            background-color: #0f172a;
            color: #e5edf7;
            border-color: #2a375a;
        }

        [data-theme="dark"] .btn-secondary-custom:hover {
            background-color: #1f2a44;
        }

        [data-theme="dark"] .filter-input {
            background-color: #0f172a;
            color: #e5edf7;
            border-color: #2a375a;
        }

        [data-theme="dark"] .filter-input::placeholder {
            color: #93a4b8;
        }

        [data-theme="dark"] .filter-input:focus {
            border-color: var(--azul-vivo);
            box-shadow: 0 0 0 3px rgba(25, 160, 230, 0.22);
        }

        [data-theme="dark"] input[type="date"].filter-input {
            color-scheme: dark;
        }

        [data-theme="dark"] input[type="date"].filter-input::-webkit-calendar-picker-indicator {
            filter: invert(1) brightness(1.15);
            opacity: 0.95;
            cursor: pointer;
        }

        [data-theme="dark"] input[type="date"].filter-input::-webkit-datetime-edit {
            color: #e5edf7;
        }

        [data-theme="dark"] input[type="date"].filter-input::-webkit-datetime-edit-text {
            color: #9aa4b2;
        }

        [data-theme="dark"] input[type="date"].filter-input::-webkit-datetime-edit-day-field,
        [data-theme="dark"] input[type="date"].filter-input::-webkit-datetime-edit-month-field,
        [data-theme="dark"] input[type="date"].filter-input::-webkit-datetime-edit-year-field {
            color: #e5edf7;
        }


        .right-column {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow: hidden;
        }


        .photo-display {
            background-color: var(--preto);
            border-radius: 8px;
            padding: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--cinza-borda);
            height: 55%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .photo-display img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .photo-display img:hover {
            opacity: 0.95;
        }

        .photo-placeholder {
            color: var(--cinza-texto);
            font-size: 14px;
            text-align: center;
            font-weight: 400;
        }


        .table-container {
            background-color: var(--branco);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            border: 1px solid var(--cinza-borda);
            height: 45%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .table-wrapper {
            overflow-y: auto;
            overflow-x: hidden;
            flex-grow: 1;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table thead th {
            background-color: var(--azul-escuro);
            color: var(--branco);
            padding: 1rem 0.6rem;
            text-align: center;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }

        [data-theme="dark"] .data-table thead th {
            background-color: #0f3b5f;
            color: #e5edf7;
            border-bottom: 1px solid #2a4f79;
        }

        .data-table tbody td {
            padding: 0.85rem 0.6rem;
            text-align: center;
            vertical-align: middle;
            border-bottom: 1px solid var(--cinza-medio);
        }

        .data-table tbody tr:hover {
            background-color: var(--cinza-claro);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .plate-cell {
            font-weight: 700;
            color: var(--azul-escuro);
            font-size: 15px;
            letter-spacing: 1px;
        }

        .img-thumbnail-lpr {
            width: 60px;
            height: 35px;
            object-fit: cover;
            cursor: pointer;
            border-radius: 3px;
            transition: transform 0.2s;
            border: 1px solid var(--cinza-borda);
        }

        .img-thumbnail-lpr:hover {
            transform: scale(1.4);
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .no-records {
            text-align: center;
            padding: 2rem;
            color: var(--cinza-texto);
            font-style: italic;
            font-size: 14px;
        }

        .last-entry-card {
            display: grid;
            grid-template-columns: minmax(0, 1fr) auto;
            grid-template-rows: auto auto auto;
            column-gap: 0.75rem;
            row-gap: 0.05rem;
            align-items: start;
        }

        .last-entry-card .metric-label {
            grid-column: 1;
            grid-row: 1;
            margin-bottom: 0.2rem;
        }

        .last-entry-card .metric-plate {
            grid-column: 1;
            grid-row: 2;
            margin: 0.1rem 0 0.1rem;
        }

        .last-entry-card .metric-time {
            grid-column: 1;
            grid-row: 3;
            margin: 0;
        }

        .unread-indicator {
            display: none;
            grid-column: 2;
            grid-row: 2 / span 2;
            align-self: start;
            justify-self: end;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.16rem;
            min-width: 72px;
            cursor: pointer;
            margin-top: 0.1rem;
        }

        .unread-indicator.show {
            display: flex;
        }

        .unread-indicator.show .unread-indicator-triangle {
            animation: unreadIndicatorPulse 0.95s ease-in-out infinite;
        }

        .unread-indicator.show .unread-indicator-text {
            animation: unreadIndicatorTextPulse 0.95s ease-in-out infinite;
            transform-origin: center center;
            display: inline-block;
            will-change: transform, opacity;
        }

        @keyframes unreadIndicatorPulse {
            0%, 100% { transform: scale(1); }
            42% { transform: scale(1.22); }
            68% { transform: scale(1.12); }
        }

        @keyframes unreadIndicatorTextPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            42% { transform: scale(1.28); opacity: 1; }
            68% { transform: scale(1.14); opacity: 0.92; }
        }

        .unread-indicator-triangle {
            width: 56px;
            height: 48px;
            background: #b42318;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 9px;
            box-shadow: 0 2px 8px rgba(180, 35, 24, 0.38);
        }

        .unread-indicator-count {
            color: #ffffff;
            font-size: 18px;
            font-weight: 800;
            line-height: 1;
        }

        .unread-indicator-text {
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.55px;
            color: #8f1d14;
        }

        
        #imageModal .modal-content {
            background-color: #212529;
            color: #ffffff;
            border: none;
        }

        #imageModal .modal-header {
            border-bottom: 1px solid #495057;
            background-color: var(--azul-escuro);
        }

        #imageModal .modal-title {
            color: #ffffff;
            font-weight: 600;
        }

        #imageModal .btn-close {
            filter: invert(1);
        }

        #imageModal .modal-body {
            padding: 0;
            background: #000000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }

        #modalImage {
            max-width: 100%;
            max-height: 80vh;
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.85) !important;
        }


        .table-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: var(--cinza-medio);
            border-radius: 3px;
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: var(--cinza-texto);
            border-radius: 3px;
        }

        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: var(--azul-escuro);
        }
    </style>
</head>
<body>
    <button type="button" class="theme-toggle" id="theme-toggle" aria-label="Alternar tema" title="Alternar tema">
        🌙
    </button>
    <div class="main-container">
  
        <div class="content-grid">

            <div class="left-column">

                <div class="logo-container">
                    <img src="/assets/logo_hr_azul.svg" alt="Logo hrlucas.dev">
                </div>


                <div class="metric-card">
                    <div class="metric-label" id="entries-label">Total de Entradas Hoje</div>
                    <p class="metric-value" id="daily-entries-count">0</p>
                    <p class="metric-datetime" id="current-datetime">--/--/---- --:--:--</p>
                </div>


                <div class="metric-card last-entry-card">
                    <div class="metric-label">Última Entrada</div>
                    <p class="metric-plate" id="last-entry-plate">-</p>
                    <p class="metric-time" id="last-entry-time">-</p>
                    <div class="unread-indicator" id="unread-indicator" role="button" tabindex="0" aria-live="polite" aria-label="Entradas não lidas">
                        <div class="unread-indicator-triangle">
                            <span class="unread-indicator-count" id="unread-indicator-count">0</span>
                        </div>
                        <div class="unread-indicator-text">Não lidas</div>
                    </div>
                </div>


                <div class="filters-card">
                    <div class="filters-title">Filtros</div>
                    <form id="filter-form">
                        <div class="filter-group">
                            <label class="filter-label" for="plate-filter">Buscar Placa</label>
                            <input type="text" class="filter-input" id="plate-filter" placeholder="Ex: ABC1234">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" for="start-date-filter">Data de início</label>
                            <input type="date" class="filter-input" id="start-date-filter">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" for="end-date-filter">Data de fim</label>
                            <input type="date" class="filter-input" id="end-date-filter">
                        </div>
                        <div class="filter-buttons">
                            <button type="submit" class="btn-filter btn-primary-custom">Filtrar</button>
                            <button type="button" class="btn-filter btn-secondary-custom" id="clear-filters">Limpar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- COLUNA DIREITA (78%) -->
            <div class="right-column">
                <!-- DISPLAY DE FOTO - SEM CAPTION -->
                <div class="photo-display" id="photo-display">
                    <img id="large-vehicle-photo" src="" alt="Veículo" style="display: none;">
                    <div class="photo-placeholder" id="photo-placeholder">Aguardando captura...</div>
                </div>



                <div class="table-container">
                    <div class="table-wrapper" id="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 8%;">ID</th>
                                    <th style="width: 14%;">Foto</th>
                                    <th style="width: 18%;">Placa</th>
                                    <th style="width: 20%;">Cor</th>
                                    <th style="width: 40%;">Data e Hora</th>
                                </tr>
                            </thead>
                            <tbody id="records-table-body">
                                <tr><td colspan="5" class="no-records">Carregando registros...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">Visualização do Veículo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <img src="" id="modalImage" alt="Foto do Veículo">
                </div>
            </div>
        </div>
    </div>

    <script>

        const isFileProtocol = window.location.protocol === 'file:';
        const API_URL = isFileProtocol ? "http://localhost:8000" : window.location.origin;
        const THEME_STORAGE_KEY = "lprTheme";
        const EXIBIR_IMAGENS = true;
        const BROKEN_IMAGE_CACHE_KEY = "lprBrokenImageUrls";
        const brokenImageUrls = new Set();
        let latestKnownRecordId = null;
        let hiddenUnreadEntriesCount = 0;
        let unreadIndicatorAutoHideTimer = null;
        let wasTableNearTop = true;
        let isFetchingRecords = false;
        let lastRenderedRecordsSignature = "";
        let tableInteractionUntil = 0;
        const AUTO_REFRESH_INTERVAL_MS = 7000;


        if (isFileProtocol) {
            console.warn("AVISO: Este arquivo está sendo aberto via file://. Acesse pelo servidor (porta configurada no .env) para funcionar corretamente.");
        }

        function aplicarTema(theme) {
            const temaNormalizado = theme === "dark" ? "dark" : "light";
            document.documentElement.setAttribute("data-theme", temaNormalizado);
            const themeToggle = document.getElementById("theme-toggle");
            if (themeToggle) {
                const mostrandoTemaEscuro = temaNormalizado === "dark";
                themeToggle.textContent = mostrandoTemaEscuro ? "☀" : "🌙";
                themeToggle.setAttribute("aria-label", mostrandoTemaEscuro ? "Ativar tema claro" : "Ativar tema escuro");
                themeToggle.setAttribute("title", mostrandoTemaEscuro ? "Ativar tema claro" : "Ativar tema escuro");
            }
        }

        function temaAtual() {
            return document.documentElement.getAttribute("data-theme") === "dark" ? "dark" : "light";
        }

        function alternarTema() {
            const proximoTema = temaAtual() === "dark" ? "light" : "dark";
            aplicarTema(proximoTema);
            try {
                window.localStorage.setItem(THEME_STORAGE_KEY, proximoTema);
            } catch (_error) {
            }
        }

        function inicializarTema() {
            let temaSalvo = "light";
            try {
                const valor = window.localStorage.getItem(THEME_STORAGE_KEY);
                if (valor === "dark" || valor === "light") {
                    temaSalvo = valor;
                }
            } catch (_error) {
            }

            aplicarTema(temaSalvo);
            const themeToggle = document.getElementById("theme-toggle");
            if (themeToggle) {
                themeToggle.addEventListener("click", alternarTema);
            }
        }


        const colorTranslator = {
            "Beige": "Bege",
            "Black": "Preto",
            "Blue": "Azul",
            "Bronze": "Bronze",
            "Brown": "Marrom",
            "Charcoal": "Grafite / Cinza Escuro",
            "Copper": "Cobre",
            "Cream": "Creme",
            "Gold": "Dourado",
            "Gray": "Cinza",
            "Green": "Verde",
            "Maroon": "Vinho / Bordô",
            "Multicolor": "Multicolorido / Fantasia",
            "Orange": "Laranja",
            "Pink": "Rosa",
            "Purple": "Roxo",
            "Red": "Vermelho",
            "Silver": "Prata",
            "Tan": "Castanho Claro / Bronzeado",
            "Turquoise": "Turquesa",
            "Violet": "Violeta",
            "White": "Branco",
            "Yellow": "Amarelo"
        };

        (function hydrateBrokenImageUrlsCache() {
            try {
                const raw = window.sessionStorage.getItem(BROKEN_IMAGE_CACHE_KEY);
                if (!raw) {
                    return;
                }

                const cachedUrls = JSON.parse(raw);
                if (!Array.isArray(cachedUrls)) {
                    return;
                }

                cachedUrls.forEach(url => {
                    if (typeof url === "string" && url.trim()) {
                        brokenImageUrls.add(url);
                    }
                });
            } catch (error) {
                console.debug("Cache de imagens quebradas indisponível.", error);
            }
        })();

        function rememberBrokenImageUrl(url) {
            if (!url || brokenImageUrls.has(url)) {
                return;
            }

            brokenImageUrls.add(url);

            try {
                const cache = Array.from(brokenImageUrls);
                const maxItems = 2000;
                if (cache.length > maxItems) {
                    cache.splice(0, cache.length - maxItems);
                }
                window.sessionStorage.setItem(BROKEN_IMAGE_CACHE_KEY, JSON.stringify(cache));
            } catch (error) {
                console.debug("Não foi possível persistir cache de imagens quebradas.", error);
            }
        }

        // Função para traduzir a cor do veículo
        function translateVehicleColor(color) {
            if (!color || color === "N/A" || color === "Unknown") {
                return "N/A";
            }
            const normalizedColor = color.trim();
            const colorKey = Object.keys(colorTranslator).find(
                key => key.toLowerCase() === normalizedColor.toLowerCase()
            );
            return colorKey ? colorTranslator[colorKey] : normalizedColor;
        }

        // Atualizar relógio abaixo do total de entradas
        function updateDateTime() {
            const now = new Date();
            const formatted = now.toLocaleString("pt-BR", {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById("current-datetime").textContent = formatted;
        }

        // Função para rolar tabela ao topo
        function scrollTableToTop() {
            const tableWrapper = document.getElementById("table-wrapper");
            if (tableWrapper) {
                tableWrapper.scrollTop = 0;
            }
        }

        function isTableNearTop() {
            const tableWrapper = document.getElementById("table-wrapper");
            if (!tableWrapper) {
                return true;
            }
            return tableWrapper.scrollTop <= 5;
        }

        function clearUnreadIndicatorAutoHideTimer() {
            if (unreadIndicatorAutoHideTimer) {
                window.clearTimeout(unreadIndicatorAutoHideTimer);
                unreadIndicatorAutoHideTimer = null;
            }
        }

        function scheduleUnreadIndicatorAutoHide() {
            if (hiddenUnreadEntriesCount <= 0 || !isTableNearTop()) {
                return;
            }

            clearUnreadIndicatorAutoHideTimer();
            unreadIndicatorAutoHideTimer = window.setTimeout(() => {
                if (isTableNearTop()) {
                    clearUnreadEntries();
                }
            }, 5000);
        }

        function syncUnreadIndicatorTopState(options = {}) {
            const nearTop = isTableNearTop();
            const fromScroll = Boolean(options.fromScroll);

            if (hiddenUnreadEntriesCount <= 0) {
                clearUnreadIndicatorAutoHideTimer();
                wasTableNearTop = nearTop;
                return;
            }

            if (nearTop) {
                if (fromScroll && !wasTableNearTop) {
                    clearUnreadEntries();
                    wasTableNearTop = true;
                    return;
                }
                scheduleUnreadIndicatorAutoHide();
            } else {
                clearUnreadIndicatorAutoHideTimer();
            }

            wasTableNearTop = nearTop;
        }

        function markTableInteraction(durationMs = 1800) {
            tableInteractionUntil = Date.now() + durationMs;
        }

        function isTableInteractionActive() {
            return Date.now() < tableInteractionUntil;
        }

        function buildRecordsSignature(records) {
            if (!Array.isArray(records) || records.length === 0) {
                return "empty";
            }

            const head = records.slice(0, 25).map(record => {
                const placaNormalizada = normalizePlate(record.placa || "-");
                return `${record.id}|${record.timestamp}|${placaNormalizada}`;
            }).join(",");
            const tail = records[records.length - 1];
            const tailPart = tail ? `${tail.id}|${tail.timestamp}` : "none";
            return `${records.length}::${head}::${tailPart}`;
        }

        function updateUnreadIndicator() {
            const indicator = document.getElementById("unread-indicator");
            const countElement = document.getElementById("unread-indicator-count");
            if (!indicator || !countElement) {
                return;
            }

            if (hiddenUnreadEntriesCount > 0) {
                countElement.textContent = String(hiddenUnreadEntriesCount);
                indicator.classList.add("show");
                const plural = hiddenUnreadEntriesCount === 1 ? "" : "s";
                indicator.setAttribute("aria-label", `${hiddenUnreadEntriesCount} entrada${plural} não lida${plural}`);
            } else {
                countElement.textContent = "0";
                indicator.classList.remove("show");
                indicator.setAttribute("aria-label", "Nenhuma entrada não lida");
            }
        }

        function clearUnreadEntries() {
            clearUnreadIndicatorAutoHideTimer();
            hiddenUnreadEntriesCount = 0;
            updateUnreadIndicator();
        }

        function markIncomingEntriesAsUnread(newRecords) {
            if (!Array.isArray(newRecords) || newRecords.length === 0) {
                return;
            }

            if (!isTableNearTop()) {
                clearUnreadIndicatorAutoHideTimer();
                hiddenUnreadEntriesCount += newRecords.length;
                updateUnreadIndicator();
                return;
            }

            syncUnreadIndicatorTopState();
        }
        function getNewRecordsSinceLastFetch(records) {
            if (!Array.isArray(records) || records.length === 0) {
                return [];
            }

            const newestRecordId = Number(records[0].id);
            if (!Number.isFinite(newestRecordId)) {
                return [];
            }

            if (latestKnownRecordId === null) {
                latestKnownRecordId = newestRecordId;
                return [];
            }

            if (newestRecordId <= latestKnownRecordId) {
                return [];
            }

            const newRecords = records.filter(record => Number(record.id) > latestKnownRecordId);
            latestKnownRecordId = newestRecordId;
            return newRecords;
        }

        function normalizePlate(plate) {
            return String(plate || "").replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
        }

        function escapeHtml(value) {
            return String(value ?? "")
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

        function formatDateTime(timestamp) {
            if (!timestamp) {
                return "-";
            }
            const date = new Date(timestamp);
            if (Number.isNaN(date.getTime())) {
                return "-";
            }
            return date.toLocaleString("pt-BR");
        }

        function formatTime(timestamp) {
            if (!timestamp) {
                return "-";
            }
            const date = new Date(timestamp);
            if (Number.isNaN(date.getTime())) {
                return "-";
            }
            return date.toLocaleTimeString("pt-BR");
        }

        function fetchRecords(options = {}) {
            const scrollToTop = Boolean(options.scrollToTop);
            const isAutoRefresh = Boolean(options.isAutoRefresh);
            const plate = document.getElementById("plate-filter").value.trim();
            const startDate = document.getElementById("start-date-filter").value.trim();
            const endDate = document.getElementById("end-date-filter").value.trim();
            const hasActiveFilters = Boolean(plate || startDate || endDate);

            if (isAutoRefresh && (
                hasActiveFilters ||
                isTableInteractionActive()
            )) {
                return;
            }

            if (isFetchingRecords) {
                return;
            }
            isFetchingRecords = true;

            const tableWrapper = document.getElementById("table-wrapper");
            const previousScrollTop = tableWrapper ? tableWrapper.scrollTop : 0;

            const params = new URLSearchParams();
            if (plate) params.append("placa", plate);
            if (startDate) params.append("data_inicio", startDate);
            if (endDate) params.append("data_fim", endDate);

            const url = `${API_URL}/api/records?${params.toString()}`;

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const records = Array.isArray(data) ? data : [];
                    const currentSignature = buildRecordsSignature(records);
                    const recordsChanged = currentSignature !== lastRenderedRecordsSignature;

                    if (recordsChanged) {
                        updateTable(records);
                        lastRenderedRecordsSignature = currentSignature;
                    }

                    updateDashboard(records, plate, startDate, endDate);

                    if (!hasActiveFilters) {
                        const newRecords = getNewRecordsSinceLastFetch(records);
                        markIncomingEntriesAsUnread(newRecords);
                    }

                    if (scrollToTop) {
                        scrollTableToTop();
                        clearUnreadEntries();
                    } else if (recordsChanged && tableWrapper) {
                        tableWrapper.scrollTop = previousScrollTop;
                    }

                    syncUnreadIndicatorTopState();
                })
                .catch(error => {
                    console.error("Erro ao buscar registros:", error);
                    document.getElementById("last-entry-plate").textContent = "ERRO";
                    document.getElementById("last-entry-time").textContent = "Servidor offline";
                    const tableBody = document.getElementById("records-table-body");
                    tableBody.innerHTML = `<tr><td colspan="5" class="no-records" style="color: #dc3545;">Erro ao conectar com o servidor. Verifique se o servidor Flask está rodando em ${API_URL}</td></tr>`;
                })
                .finally(() => {
                    isFetchingRecords = false;
                });
        }

        function updateTable(records) {
            const tableBody = document.getElementById("records-table-body");
            if (records.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="no-records">Nenhum registro encontrado</td></tr>`;
                return;
            }
            
            tableBody.innerHTML = "";
            records.forEach(record => {
                const row = document.createElement("tr");
                const translatedColor = translateVehicleColor(record.cor_veiculo);
                const imageUrl = record.imagem_url ? `${API_URL}${record.imagem_url}` : "";
                const shouldShowImage = EXIBIR_IMAGENS && Boolean(imageUrl) && !brokenImageUrls.has(imageUrl);
                const imageHtml = shouldShowImage
                    ? `<img src="${imageUrl}" loading="lazy" class="img-thumbnail-lpr" onclick="showImage('${imageUrl}', '${record.placa}')" alt="Veículo">`
                    : '<span style="color: #999; font-size: 11px;">Sem foto</span>';

                row.innerHTML = `
                    <td>${record.id}</td>
                    <td>${imageHtml}</td>
                    <td class="plate-cell">${escapeHtml(record.placa || "-")}</td>
                    <td>${escapeHtml(translatedColor)}</td>
                    <td>${formatDateTime(record.timestamp)}</td>
                `;

                const thumbnail = row.querySelector(".img-thumbnail-lpr");
                if (thumbnail && imageUrl) {
                    thumbnail.addEventListener("error", () => {
                        rememberBrokenImageUrl(imageUrl);
                        const cell = thumbnail.parentElement;
                        if (cell) {
                            cell.innerHTML = '<span style="color: #999; font-size: 11px;">Sem foto</span>';
                        }
                    }, { once: true });
                }
                tableBody.appendChild(row);
            });
        }

        function updateDashboard(records, plate, startDate, endDate) {
            // Detecta os filtros ativos
            const hasPlateFilter = plate && plate.trim();
            const hasPeriodFilter = (startDate && startDate.trim()) || (endDate && endDate.trim());
            
            // Atualiza o label do card
            const entriesLabel = document.getElementById("entries-label");
            if (hasPlateFilter || hasPeriodFilter) {
                entriesLabel.textContent = "Entradas Correspondentes";
            } else {
                entriesLabel.textContent = "Total de Entradas Hoje";
            }
            
            // Conta as entradas
            if (hasPeriodFilter) {
                document.getElementById("daily-entries-count").textContent = records.length;
            } else {
                const today = new Date().toISOString().split("T")[0];
                document.getElementById("daily-entries-count").textContent = records.filter(r => r.timestamp?.startsWith(today)).length;
            }
            
            // Atualiza o último veículo e foto grande
            if (records.length > 0) {
                const lastRecord = records[0];
                document.getElementById("last-entry-plate").textContent = lastRecord.placa;
                document.getElementById("last-entry-time").textContent = new Date(lastRecord.timestamp).toLocaleTimeString("pt-BR");
                
                // Atualiza a foto grande - SEM CAPTION
                const largePhoto = document.getElementById("large-vehicle-photo");
                const photoPlaceholder = document.getElementById("photo-placeholder");
                
                const imageUrl = lastRecord.imagem_url ? `${API_URL}${lastRecord.imagem_url}` : "";
                const shouldShowDashboardImage = EXIBIR_IMAGENS && Boolean(imageUrl) && !brokenImageUrls.has(imageUrl);
                if (shouldShowDashboardImage) {
                    largePhoto.src = imageUrl;
                    largePhoto.style.display = "block";
                    photoPlaceholder.style.display = "none";
                    largePhoto.onerror = () => {
                        rememberBrokenImageUrl(imageUrl);
                        largePhoto.removeAttribute("src");
                        largePhoto.onclick = null;
                        largePhoto.style.display = "none";
                        photoPlaceholder.style.display = "block";
                    };

                    // Clique para ampliar
                    largePhoto.onclick = () => showImage(imageUrl, lastRecord.placa);
                } else {
                    largePhoto.removeAttribute("src");
                    largePhoto.onerror = null;
                    largePhoto.onclick = null;
                    largePhoto.style.display = "none";
                    photoPlaceholder.style.display = "block";
                }
            } else {
                document.getElementById("last-entry-plate").textContent = "-";
                document.getElementById("last-entry-time").textContent = "-";
                const largePhoto = document.getElementById("large-vehicle-photo");
                largePhoto.removeAttribute("src");
                largePhoto.onerror = null;
                largePhoto.onclick = null;
                largePhoto.style.display = "none";
                document.getElementById("photo-placeholder").style.display = "block";
            }
        }

        function showImage(url, plate) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalLabel = document.getElementById('imageModalLabel');
            
            if (!modal || !modalImage || !modalLabel) {
                console.error('Modal elements not found');
                return;
            }
            
            modalImage.src = url;
            modalLabel.textContent = `Veículo: ${plate}`;
            
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();
            } else {
                modal.style.display = 'block';
                modal.classList.add('show');
                document.body.classList.add('modal-open');
                
                let backdrop = document.querySelector('.modal-backdrop');
                if (!backdrop) {
                    const backdropElement = document.createElement('div');
                    backdropElement.className = 'modal-backdrop fade show';
                    backdropElement.style.backgroundColor = 'rgba(0, 0, 0, 0.85)';
                    document.body.appendChild(backdropElement);
                    backdrop = backdropElement;
                }
                
                backdrop.onclick = (e) => {
                    if (e.target === backdrop) {
                        closeModal();
                    }
                };
            }
        }
        
        function closeModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
                document.body.classList.remove('modal-open');
                
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
            }
        }
        
        window.showImage = showImage;

        // Event Listeners
        document.getElementById("clear-filters").addEventListener("click", () => {
            document.getElementById("filter-form").reset();
            fetchRecords({ scrollToTop: true });
        });


        const unreadIndicator = document.getElementById("unread-indicator");
        if (unreadIndicator) {
            const openUnreadEntries = () => {
                scrollTableToTop();
                clearUnreadEntries();
            };

            unreadIndicator.addEventListener("click", openUnreadEntries);
            unreadIndicator.addEventListener("keydown", (event) => {
                if (event.key === "Enter" || event.key === " ") {
                    event.preventDefault();
                    openUnreadEntries();
                }
            });
        }

        const tableWrapper = document.getElementById("table-wrapper");
        if (tableWrapper) {
            tableWrapper.addEventListener("scroll", () => {
                markTableInteraction();
                syncUnreadIndicatorTopState({ fromScroll: true });
            });

            tableWrapper.addEventListener("wheel", () => {
                markTableInteraction();
            }, { passive: true });

            tableWrapper.addEventListener("touchmove", () => {
                markTableInteraction();
            }, { passive: true });
        }

        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "visible") {
                fetchRecords({ isAutoRefresh: true });
                syncUnreadIndicatorTopState();
            }
        });

        document.addEventListener("DOMContentLoaded", () => {
            inicializarTema();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            updateUnreadIndicator();
            wasTableNearTop = isTableNearTop();
            syncUnreadIndicatorTopState();
            
            fetchRecords({ isAutoRefresh: true });
            setInterval(() => fetchRecords({ isAutoRefresh: true }), AUTO_REFRESH_INTERVAL_MS);
            
            document.getElementById("filter-form").addEventListener("submit", (e) => {
                e.preventDefault();
                fetchRecords({ scrollToTop: true });
            });
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
